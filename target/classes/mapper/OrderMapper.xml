<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.industrial.trading.dao.OrderMapper">
    
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.industrial.trading.entity.Order">
        <id property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="buyerId" column="buyer_id"/>
        <result property="sellerId" column="seller_id"/>
        <result property="productId" column="product_id"/>
        <result property="productName" column="product_name"/>
        <result property="productImage" column="product_image"/>
        <result property="price" column="price"/>
        <result property="quantity" column="quantity"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="receiverName" column="receiver_name"/>
        <result property="receiverPhone" column="receiver_phone"/>
        <result property="receiverAddress" column="receiver_address"/>
        <result property="remark" column="remark"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="payTime" column="pay_time"/>
        <result property="shipTime" column="ship_time"/>
        <result property="finishTime" column="finish_time"/>
    </resultMap>
    
    <!-- 扩展结果映射(包含关联信息) -->
    <resultMap id="ExtendedResultMap" type="com.industrial.trading.entity.Order" extends="BaseResultMap">
        <association property="buyer" javaType="com.industrial.trading.entity.User">
            <id property="id" column="buyer_id"/>
            <result property="username" column="buyer_username"/>
            <result property="realName" column="buyer_realname"/>
        </association>
        <association property="seller" javaType="com.industrial.trading.entity.User">
            <id property="id" column="seller_id"/>
            <result property="username" column="seller_username"/>
            <result property="realName" column="seller_realname"/>
        </association>
    </resultMap>
    
    <!-- 根据ID查询订单 -->
    <select id="selectById" resultMap="ExtendedResultMap">
        SELECT o.*, 
               bu.username as buyer_username, bu.realname as buyer_realname,
               su.username as seller_username, su.realname as seller_realname
        FROM `order` o
        LEFT JOIN user bu ON o.buyer_id = bu.id
        LEFT JOIN user su ON o.seller_id = su.id
        WHERE o.id = #{id}
    </select>
    
    <!-- 根据订单号查询订单 -->
    <select id="selectByOrderNo" resultMap="ExtendedResultMap">
        SELECT o.*, 
               bu.username as buyer_username, bu.realname as buyer_realname,
               su.username as seller_username, su.realname as seller_realname
        FROM `order` o
        LEFT JOIN user bu ON o.buyer_id = bu.id
        LEFT JOIN user su ON o.seller_id = su.id
        WHERE o.order_no = #{orderNo}
    </select>
    
    <!-- 查询订单列表 -->
    <select id="selectList" resultMap="ExtendedResultMap" parameterType="map">
        SELECT o.*, 
               bu.username as buyer_username, bu.realname as buyer_realname,
               su.username as seller_username, su.realname as seller_realname
        FROM `order` o
        LEFT JOIN user bu ON o.buyer_id = bu.id
        LEFT JOIN user su ON o.seller_id = su.id
        <where>
            <if test="buyerId != null">
                AND o.buyer_id = #{buyerId}
            </if>
            <if test="sellerId != null">
                AND o.seller_id = #{sellerId}
            </if>
            <if test="status != null">
                AND o.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (o.order_no LIKE CONCAT('%', #{keyword}, '%') 
                     OR o.product_name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY o.create_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 查询订单总数 -->
    <select id="selectCount" resultType="int" parameterType="map">
        SELECT COUNT(*) FROM `order` o
        <where>
            <if test="buyerId != null">
                AND o.buyer_id = #{buyerId}
            </if>
            <if test="sellerId != null">
                AND o.seller_id = #{sellerId}
            </if>
            <if test="status != null">
                AND o.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (o.order_no LIKE CONCAT('%', #{keyword}, '%') 
                     OR o.product_name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>
    
    <!-- 插入订单 -->
    <insert id="insert" parameterType="com.industrial.trading.entity.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (order_no, buyer_id, seller_id, product_id, product_name, product_image,
                           price, quantity, total_amount, receiver_name, receiver_phone, receiver_address, remark, status)
        VALUES (#{orderNo}, #{buyerId}, #{sellerId}, #{productId}, #{productName}, #{productImage},
                #{price}, #{quantity}, #{totalAmount}, #{receiverName}, #{receiverPhone}, #{receiverAddress}, #{remark}, #{status})
    </insert>
    
    <!-- 更新订单状态 -->
    <update id="updateStatus">
        UPDATE `order` SET status = #{status} WHERE id = #{id}
    </update>
    
</mapper>
